
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>æµ·ä¾¨æ±‡é€šä¸ªäººå®¢æˆ·æ³¨å†Œè¡¨</title>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <style>
    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      background-color: #f9f9fb;
      padding: 40px;
      color: #333;
      max-width: 800px;
      margin: auto;
    }
    h1 { text-align: center; color: #1a5dbb; }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      background-color: #1a5dbb;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      display: block;
      margin: 30px auto;
    }
  </style>
</head>
<body>

  <h1>æµ·ä¾¨æ±‡é€šä¸ªäººå®¢æˆ·æ³¨å†Œè¡¨</h1>
  <p style="text-align:center;color:#666;">è¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼Œç³»ç»Ÿå°†ä¸ºæ‚¨ç”Ÿæˆæ­£å¼å¼€æˆ·è¡¨</p>

  <form id="webForm">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
      <div class="form-group">
        <label>Surname (å§“) *</label>
        <input type="text" id="surname" required />
      </div>
      <div class="form-group">
        <label>Given Name (å) *</label>
        <input type="text" id="givenName" required />
      </div>

      <div class="form-group">
        <label>Date of Birth (å‡ºç”Ÿæ—¥æœŸ) *</label>
        <input type="date" id="dob" required />
      </div>
      <div></div>

      <div class="form-group">
        <label>Residential Address (å®¶åº­ä½å€) *</label>
        <input type="text" id="address" required />
      </div>
      <div class="form-group">
        <label>Suburb (åŒº) *</label>
        <input type="text" id="suburb" required />
      </div>

      <div class="form-group">
        <label>State (å·) *</label>
        <input type="text" id="state" required />
      </div>
      <div class="form-group">
        <label>Postcode (é‚®ç¼–) *</label>
        <input type="text" id="postcode" required />
      </div>

      <div class="form-group">
        <label>Country (å›½å®¶)</label>
        <input type="text" id="country" value="Australia" required />
      </div>
      <div class="form-group">
        <label>Mobile (æ‰‹æœº) </label>
        <input type="text" id="mobile"  />
      </div>

      <div class="form-group">
        <label>Home/Biz No. (å®¶åº­/å·¥ä½œç”µè¯) </label>
        <input type="text" id="phone" />
      </div>
      <div class="form-group">
        <label>Email (ç”µå­é‚®ä»¶) </label>
        <input type="email" id="email"  />
      </div>

      <div class="form-group">
        <label>Occupation (èŒä¸š) </label>
        <input type="text" id="occupation" />
      </div>
      <div class="form-group">
        <label>Contact App (é€šè®¯è½¯ä»¶)</label>
        <select id="contactApp">
          <option value="">è¯·é€‰æ‹©</option>
          <option value="WeChat">WeChat</option>
          <option value="WhatsApp">WhatsApp</option>
          <option value="Telegram">Telegram</option>
          <option value="Other">å…¶ä»–</option>
        </select>
      </div>

      <div class="form-group">
        <label>Account No. (è´¦æˆ·å·)</label>
        <input type="text" id="accountNo" />
      </div>
    </div>

    <button type="button" id="generatePdf">ç”ŸæˆPDF</button>
  </form>

  <script>
      (function () {
        const qs = new URLSearchParams(window.location.search);
        if (!qs.toString()) return;            // æ²¡æœ‰ä»»ä½•æŸ¥è¯¢å‚æ•°å°±ä¸åšäº‹
        // å¦‚æœä½ æƒ³â€œåªæœ‰å¸¦ autofill=1 æ‰é¢„å¡«â€ï¼Œå°±æ”¹æˆï¼šif (qs.get('autofill') !== '1') return;

        // å·¥å…·ï¼šå®‰å…¨è®¾ç½®å€¼å¹¶è§¦å‘ input/change
        function setValById(id, val) {
          if (!val) return;
          const el = document.getElementById(id);
          if (!el) return;
          el.value = val;
          el.dispatchEvent(new Event('input', { bubbles: true }));
          el.dispatchEvent(new Event('change', { bubbles: true }));
        }

        // å·¥å…·ï¼šæŠŠ YYYY-MM-DD è½¬æ¢ä¸º dd/mm/yyyyï¼›å·²æ˜¯ dd/mm/yyyy åˆ™åŸæ ·è¿”å›
        function normalizeDob(v) {
          if (!v) return v;
          // yyyy-mm-dd
          const m = v.match(/^(\d{4})-(\d{2})-(\d{2})$/);
          if (m) return `${m[3]}/${m[2]}/${m[1]}`;
          return v;
        }

        // å–å‚å¹¶å†™å…¥ï¼ˆå‚æ•°åâ†’è¾“å…¥æ¡† id ä¸€ä¸€å¯¹åº”ï¼‰
        const map = [
          ['surname',     'surname'],
          ['givenName',   'givenName'],
          ['address',     'address'],
          ['suburb',      'suburb'],
          ['state',       'state'],
          ['postcode',    'postcode'],
          ['country',     'country'],
          ['mobile',      'mobile'],
          ['phone',       'phone'],
          ['email',       'email'],
          ['occupation',  'occupation'],
          ['accountNo',   'accountNo'],
        ];

        // ç”Ÿæ—¥å•ç‹¬å¤„ç†ï¼ˆè€ƒè™‘ yyyy-mm-ddâ†’dd/mm/yyyyï¼‰
        const dobParam = qs.get('dob');
        if (dobParam) {
          // ä½ çš„ input æ˜¯ <input type="date">ï¼Œæµè§ˆå™¨æ¥å— yyyy-mm-ddï¼›
          // ä½†ä½ çš„ PDF ç”Ÿæˆéœ€è¦ dd/mm/yyyyï¼Œæ‰€ä»¥ï¼š
          // 1) input é‡Œè®¾ç½® yyyy-mm-ddï¼ˆè‹¥ä¼ æ¥çš„æ˜¯ dd/mm/yyyyï¼Œæˆ‘ä»¬è½¬æ¢å› yyyy-mm-dd ä¾› <input type="date"> ç”¨ï¼‰
          // 2) ä½ ç”Ÿæˆ PDF æ—¶ä»ä¼šç”¨ formatDate() å˜æˆ dd/mm/yyyy è¾“å‡º
          const dobInput = document.getElementById('dob');
          if (dobInput) {
            let iso = dobParam;
            // å¦‚æœæ˜¯ dd/mm/yyyyï¼ŒæŠŠå®ƒè½¬å› yyyy-mm-dd ç»™ <input type="date">
            const dm = dobParam.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
            if (dm) iso = `${dm[3]}-${dm[2]}-${dm[1]}`;
            dobInput.value = iso;
            dobInput.dispatchEvent(new Event('input', { bubbles: true }));
            dobInput.dispatchEvent(new Event('change', { bubbles: true }));
          }
        }

        // å…¶å®ƒå¸¸è§„å­—æ®µ
        map.forEach(([q, id]) => setValById(id, qs.get(q)));

        // Contact App ä¸‹æ‹‰
        const contactApp = qs.get('contactApp');
        if (contactApp) {
          const sel = document.getElementById('contactApp');
          if (sel) {
            sel.value = contactApp;
            sel.dispatchEvent(new Event('change', { bubbles: true }));
          }
        }

        // å¯é€‰ï¼šå¸¦ autoprint=1 å°±è‡ªåŠ¨ç”Ÿæˆ PDF
        if (qs.get('autoprint') === '1') {
          const btn = document.getElementById('generatePdf');
          // ç»™ä¸€ç‚¹æ—¶é—´è®©æµè§ˆå™¨æŠŠå€¼å†™è¿›æ§ä»¶
          setTimeout(() => btn && btn.click(), 100);
        }
      })();
  </script>


  <script>
    const { PDFDocument, rgb } = PDFLib;

    // ğŸ”§ æ‚¨äº²è‡ªæµ‹è¯•å‡ºçš„æœ€ä½³åæ ‡ï¼ˆå·²éªŒè¯å¯¹é½ï¼‰
    const FIELD_POSITIONS = {
      surname:     { x: 120, y: 148 },
      givenName:   { x: 400, y: 148 },
      dob:         { x: 200, y: 164 },
      address:     { x: 200, y: 179 },
      suburb:      { x: 120, y: 192 },
      state:       { x: 380, y: 192 },
      postcode:    { x: 130, y: 208 },
      country:     { x: 400, y: 208 },
      mobile:      { x: 130, y: 222 },
      phone:       { x: 450, y: 222 },
      email:       { x: 150, y: 237 },
      occupation:  { x: 450, y: 237 },
      contactApp:  { x: 180, y: 252 },
      accountNo:   { x: 450, y: 252 }
    };

    document.getElementById("generatePdf").onclick = async () => {
      const data = {
        surname: document.getElementById("surname").value.trim(),
        givenName: document.getElementById("givenName").value.trim(),
        dob: formatDate(document.getElementById("dob").value),
        address: document.getElementById("address").value.trim(),
        suburb: document.getElementById("suburb").value.trim(),
        state: document.getElementById("state").value.trim(),
        postcode: document.getElementById("postcode").value.trim(),
        country: document.getElementById("country").value.trim(),
        mobile: document.getElementById("mobile").value.trim(),
        phone: document.getElementById("phone").value.trim(),
        email: document.getElementById("email").value.trim(),
        occupation: document.getElementById("occupation").value.trim(),
        contactApp: document.getElementById("contactApp").value || "",
        accountNo: document.getElementById("accountNo").value.trim(),
      };

      // éªŒè¯å¿…å¡«é¡¹
      const requiredFields = ['surname', 'givenName', 'dob', 'address', 'suburb', 'state', 'postcode', 'country'];
      for (const field of requiredFields) {
        if (!data[field]) {
          alert(`è¯·å¡«å†™ï¼š${document.querySelector(`[for="${field}"]`)?.textContent || field}`);
          return;
        }
      }

      try {
        // åŠ è½½åŸå§‹æ¨¡æ¿
        const templateUrl = 'template.pdf';
        const templateBytes = await fetch(templateUrl).then(res => res.arrayBuffer());
        const pdfDoc = await PDFDocument.load(templateBytes);
        const page = pdfDoc.getPages()[0];
        const pageHeight = page.getHeight(); // A4: 842pt

        const fontSize = 10;
        const textColor = rgb(0, 0, 0); // é»‘è‰²

        // å†™å…¥æ¯ä¸ªå­—æ®µï¼ˆä½¿ç”¨æ‚¨æµ‹è¯•å‡ºçš„ç²¾ç¡®åæ ‡ï¼‰
        for (const [key, pos] of Object.entries(FIELD_POSITIONS)) {
          const value = data[key];
          if (value) {
            // å…³é”®ï¼šY åæ ‡è½¬æ¢ä¸º pdf-lib çš„å·¦ä¸‹è§’åæ ‡ç³»
            const y = pageHeight - pos.y;
            page.drawText(value, {
              x: pos.x,
              y: y,
              size: fontSize,
              color: textColor
            });
          }
        }

        // ä¿å­˜å¹¶ä¸‹è½½
        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const gn = String(document.getElementById("givenName").value || "").trim();
        const sn = String(document.getElementById("surname").value || "").trim();
        a.download = `ä¸ªäººå¼€æˆ·è¡¨æ ¼-${[gn, sn].filter(Boolean).join(" ")}.pdf`;
        a.click();

      } catch (error) {
        console.error("PDFç”Ÿæˆå¤±è´¥:", error);
        alert("æœªæ‰¾åˆ° template.pdfï¼Œè¯·ç¡®ä¿å®ƒä¸æœ¬æ–‡ä»¶åœ¨åŒä¸€ç›®å½•ã€‚\n" + error.message);
      }
    };

    // æ ¼å¼åŒ–å‡ºç”Ÿæ—¥æœŸæ˜¾ç¤º
    function formatDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
    }

    // ç”¨äºæ–‡ä»¶åçš„æ—¶é—´æˆ³
    function formatFilenameDate() {
      const d = new Date();
      return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
    }
  </script>
</body>
</html>
